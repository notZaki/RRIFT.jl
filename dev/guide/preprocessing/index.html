<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Pre-processing · RRIFT.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">RRIFT.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Guide</span><ul><li><a class="tocitem" href="../downloading/">Downloading</a></li><li class="is-active"><a class="tocitem" href>Pre-processing</a><ul class="internal"><li><a class="tocitem" href="#T1-mapping-1"><span>T1 mapping</span></a></li><li><a class="tocitem" href="#DCE-MRI-signal-to-concentration-conversion-1"><span>DCE-MRI signal to concentration conversion</span></a></li><li><a class="tocitem" href="#Wrapper-function-for-T1-mapping-and-signal-concentration-conversion-1"><span>Wrapper function for T1 mapping and signal-concentration conversion</span></a></li><li><a class="tocitem" href="#Applying-masks-1"><span>Applying masks</span></a></li><li><a class="tocitem" href="#(Another)-Wrapper-function-for-all-pre-processing-steps-1"><span>(Another) Wrapper function for all pre-processing steps</span></a></li></ul></li><li><a class="tocitem" href="../fitting/">Fitting</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Guide</a></li><li class="is-active"><a href>Pre-processing</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Pre-processing</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/notZaki/RRIFT.jl/blob/master/docs/src/guide/preprocessing.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Pre-processing-1"><a class="docs-heading-anchor" href="#Pre-processing-1">Pre-processing</a><a class="docs-heading-anchor-permalink" href="#Pre-processing-1" title="Permalink"></a></h1><p>Before applying RRIFT, there&#39;s a couple of pre-processing steps including:</p><ol><li>Load imaging data from the VFA DICOM files &amp; compute T1 maps</li><li>Load imaging data form the DCE DICOM files &amp; convert the DCE-MRI signal into tracer concentration</li><li>Extract signal-time curves from the tumour, muscle, and artery for subsequent model fitting</li></ol><p><strong>Download DICOM files</strong></p><p>The pre-processing steps will be shown for a single patient. First, the DICOM files must be downloaded.</p><pre><code class="language-julia">chosen_study_uid = RRIFT.gbm_study_uids[8]

dicom_folders = download_invivo_studies(chosen_study_uid,
    destination = &quot;./data/tcga-gbm-dicom&quot;)

# Extract the vfa and dce folders from `dicom_folders`
vfa_folder = dicom_folders.vfa_folders[1]
dce_folder = dicom_folders.dce_folders[1]

println(&quot;VFA: $vfa_folder&quot;)
println(&quot;DCE: $dce_folder&quot;)</code></pre><pre><code class="language-none">VFA: ./data/tcga-gbm-dicom/1.3.6.1.4.1.14519.5.2.1.4591.4001.304604545029494418165835320551/vfa
DCE: ./data/tcga-gbm-dicom/1.3.6.1.4.1.14519.5.2.1.4591.4001.304604545029494418165835320551/dce</code></pre><h2 id="T1-mapping-1"><a class="docs-heading-anchor" href="#T1-mapping-1">T1 mapping</a><a class="docs-heading-anchor-permalink" href="#T1-mapping-1" title="Permalink"></a></h2><p>T1 mapping is provided by the <code>fit_relaxation</code> function.  There are three algorithms for T1 mapping:</p><ol><li>Non-linear least squares fitting of the spoiled gradient echo equation</li><li>Linear least squares fitting with <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/mrm.20314">DESPOT1</a></li><li>Iterative fitting with <a href="https://ieeexplore.ieee.org/document/8371285">NOVIFAST</a></li></ol><p>The fitting algorithm is selected by passing either <code>:nls</code>, <code>:despot</code>, or <code>:novifast</code> as the first argument. This example uses DESPOT1 because that is what the paper used. I wasn&#39;t aware of NOVIFAST when I wrote the paper, or else I probably would&#39;ve used it instead of DESPOT1.</p><pre><code class="language-julia"># Load VFA data
vfa = RRIFT.load_vfa_dicom(folder = vfa_folder)

println(&quot;&quot;&quot;
Some information for VFA data:
    - It is a named tuple with keys: $(keys(vfa))
    - Number of flip angles: $(length(vfa.angles))
    - Value of flip angles, in degrees: $(sort(round.(rad2deg.(vfa.angles))))
    - Size of signal data: $(size(vfa.signal))
    - Repetition time, in ms: $(vfa.TR)
&quot;&quot;&quot;)

# Compute T1 maps using DESPOT1
relaxation_maps = fit_relaxation(:despot; vfa...).estimates

# The variable `relaxation_maps` contains the keys: T1 &amp; M0
keys(relaxation_maps)</code></pre><pre><code class="language-none">(:M0, :T1)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The <code>fit_relaxation</code> function expects the first argument to be a symbol followed by keyword arguments.  The keywords are <code>signal</code>, <code>angles</code>, and <code>TR</code>.  In others words, it could&#39;ve been written as: <code>fit_relaxation(:despot, signal = vfa.signal, angles = vfa.angles, TR = vfa.TR)</code>. However, since the keys in <code>vfa</code> match the function&#39;s keywords, we can just splat it with <code>...</code>. </p></div></div><pre><code class="language-julia"># Remove empty rows/columns for display purposes
M0 = crop(relaxation_maps.M0)
T1 = crop(relaxation_maps.T1)

slice = 8
figopts = (c = :cinferno, yflip = true, aspect_ratio = :equal, axis = nothing)
p1 = heatmap(M0[:,:,slice]; clim=(0, 15000), title=&quot;M0&quot;, figopts...)
p2 = heatmap(T1[:,:,slice]; clim=(500, 3000), title=&quot;T1&quot;, figopts...)
plot(p1, p2, layout=(1,2))</code></pre><p><img src="../relaxation_maps.png" alt="relaxation_maps"/></p><h2 id="DCE-MRI-signal-to-concentration-conversion-1"><a class="docs-heading-anchor" href="#DCE-MRI-signal-to-concentration-conversion-1">DCE-MRI signal to concentration conversion</a><a class="docs-heading-anchor-permalink" href="#DCE-MRI-signal-to-concentration-conversion-1" title="Permalink"></a></h2><p>The T1 map is used to convert the DCE-MRI signal into tracer concentration.</p><pre><code class="language-julia"># Load the DCE-MRI data
dce = RRIFT.load_dce_dicom(folder = dce_folder)

println(&quot;&quot;&quot;
Some information for DCE data:
    - It is a named tuple with keys: $(keys(dce))
    - Size of signal data: $(size(dce.signal))
    - Number of timepoints/frames: $(length(dce.timepoints))
    - Flip angle, in degrees: $(rad2deg(dce.angle))
    - Repetition time, in ms: $(dce.TR)
&quot;&quot;&quot;)

r1 = 3.3/1000 # Relaxivity of Gd-DTPA at 3T, in mM/ms. Ref: PMID 16481903
BAF = 3 # Bolus arrival frame, i.e. the frame at which the tracer arrives in the imaging volume
R10 = 1 ./ relaxation_maps.T1 # The function wants R1 instead of T1

concentration = signal_to_concentration(dce.signal;
    angle = dce.angle, TR = dce.TR, R10 = R10, BAF = BAF, r1 = r1)
println(&quot;Concentration size: $(size(concentration))&quot;)</code></pre><pre><code class="language-none">Some information for DCE data:
    - It is a named tuple with keys: (:signal, :timepoints, :TR, :angle)
    - Size of signal data: (256, 256, 16, 70)
    - Number of timepoints/frames: 70
    - Flip angle, in degrees: 20.0
    - Repetition time, in ms: 5.044

Concentration size: (256, 256, 16, 70)</code></pre><h2 id="Wrapper-function-for-T1-mapping-and-signal-concentration-conversion-1"><a class="docs-heading-anchor" href="#Wrapper-function-for-T1-mapping-and-signal-concentration-conversion-1">Wrapper function for T1 mapping and signal-concentration conversion</a><a class="docs-heading-anchor-permalink" href="#Wrapper-function-for-T1-mapping-and-signal-concentration-conversion-1" title="Permalink"></a></h2><p>The functions in the previous section were shown for educational purposes.  The <code>compute_concentration</code> function wraps the previous steps together:</p><pre><code class="language-julia">computed = compute_concentration(vfa_folder = vfa_folder, dce_folder = dce_folder)

println(&quot;&quot;&quot;
Some information for the computed maps:
    - It is a named tuple with keys: $keys(computed)
    - Does it have the same T1 map as we computed earlier? $(all(@. (computed.T1 == relaxation_maps.T1)[!isnan(computed.T1)]))
    - Does it have the same concentration as computed earlier? $(all(@. (computed.ct == concentration)[!isnan(concentration)]))
&quot;&quot;&quot;)</code></pre><pre><code class="language-none">Some information for the computed maps:
    - It is a named tuple with keys: keys(computed)
    - Does it have the same T1 map as we computed earlier? true
    - Does it have the same concentration as computed earlier? true</code></pre><h2 id="Applying-masks-1"><a class="docs-heading-anchor" href="#Applying-masks-1">Applying masks</a><a class="docs-heading-anchor-permalink" href="#Applying-masks-1" title="Permalink"></a></h2><p>Pharmacoknetic modelling of DCE-MRI requires concentration-time curves from:</p><ul><li>the tissue of interest (tumour in our cases) denoted as <code>ct</code></li><li>the feeding artery (arterial input function / AIF) denoted as <code>cp</code><ul><li>technically, it should be <code>cb</code> and we&#39;ll actually be using a vein instead of artery</li></ul></li><li>a healthy reference tissue (muscle) denoted as <code>crr</code></li></ul><p>Not all models require the same curves. For example, the well-established Tofts model only needs <code>ct</code> and <code>cp</code>, whereas the reference region model needs <code>ct</code> and <code>crr</code>.</p><p>Contours/masks for the tumour/muscle/blood-vessel were manually drawn and they can be downloaded by:</p><pre><code class="language-julia">mask_folder = &quot;./data/tcga-gbm-masks&quot;
download_invivo_masks(destination = mask_folder)</code></pre><pre><code class="language-none">&quot;./data/tcga-gbm-masks&quot;</code></pre><p>Masks can be loaded and applied by:</p><pre><code class="language-julia"># Get masks for the chosen study
mask = get_mask(study = chosen_study_uid, mask_folder = mask_folder)
println(&quot;Mask has keys: $(keys(mask))&quot;)

hematocrit = 0.4 # For AIF (assumed value)

t = computed.t
ct = apply_mask(data = computed.ct, mask = mask.tumour)
cp = apply_mask(data = computed.ct, mask = mask.aif) ./ (1 - 0.4)
crr = apply_mask(data = computed.ct, mask = mask.muscle)

# cp and crr are averaged because only a single representative curve is needed from each
cp = vec(mean(cp, dims=1))
crr = vec(mean(crr, dims=1))
nothing # Suppressing output</code></pre><pre><code class="language-none">Mask has keys: (:aif, :muscle, :tumour)</code></pre><h2 id="(Another)-Wrapper-function-for-all-pre-processing-steps-1"><a class="docs-heading-anchor" href="#(Another)-Wrapper-function-for-all-pre-processing-steps-1">(Another) Wrapper function for all pre-processing steps</a><a class="docs-heading-anchor-permalink" href="#(Another)-Wrapper-function-for-all-pre-processing-steps-1" title="Permalink"></a></h2><p>The pre-processing steps—i.e. T1 mapping, signal-concentration conversion, masking—are needed for each study. Rather than repeating these steps every time, a wrapper function named <code>preprocess_dicom_to_mat</code> is used.  This function applies all of the preceding steps and saves the result as a MATLAB-compatible .mat file.</p><pre><code class="language-julia-repl">julia&gt; preprocessed_mat_files = preprocess_dicom_to_mat(
           destination = &quot;./data/tcga-gbm-mat-test&quot;,
           dicom_folders = dicom_folders,
           mask_folder = mask_folder)
1-element Array{String,1}:
 &quot;./data/tcga-gbm-mat-test/1.3.6.1.4.1.14519.5.2.1.4591.4001.304604545029494418165835320551.mat&quot;</code></pre><p>The saved .mat file can be loaded back into Julia by</p><pre><code class="language-julia">mat_data = load_preprocessed_mat(preprocessed_mat_files[1])

println(&quot;&quot;&quot;
Some information for the loaded mat_data
    - It is a named tuple with keys: $(keys(mat_data))
    - `masks` is a dictionary with keys: $(keys(mat_data.masks))
    - `relaxation` is a dictionary with keys: $(keys(mat_data.relaxation))
&quot;&quot;&quot;)</code></pre><pre><code class="language-none">Some information for the loaded mat_data
    - It is a named tuple with keys: (:t, :ct, :crr, :cp, :relaxation, :masks)
    - `masks` is a dictionary with keys: [&quot;muscle&quot;, &quot;tumour&quot;, &quot;aif&quot;]
    - `relaxation` is a dictionary with keys: [&quot;M0&quot;, &quot;T1&quot;]</code></pre><p>All 8 DCE-MRI studies can be pre-processed by running the following three lines:</p><pre><code class="language-julia">dicom_folders = download_invivo_studies(destination = &quot;./data/tcga-gbm-dicom&quot;)
mask_folder = download_invivo_masks(destination = &quot;./data/tcga-gbm-masks&quot;)
preprocess_dicom_to_mat(destination = &quot;./data/tcga-gbm-mat&quot;, 
    dicom_folders = dicom_folders, mask_folder = mask_folder)</code></pre><p>To save time, these steps were already done and the pre-processed files can be downloaded directly by:</p><pre><code class="language-julia">mat_dir = &quot;./data/tcga-gbm-mat&quot;
download_invivo_preprocessed(destination = mat_dir)

# Confirm that files were downloaded:
mat_files = readdir(mat_dir)</code></pre><pre><code class="language-none">8-element Array{String,1}:
 &quot;1.3.6.1.4.1.14519.5.2.1.4591.4001.100057969162276274933613772317.mat&quot;
 &quot;1.3.6.1.4.1.14519.5.2.1.4591.4001.269887096484012292940330991126.mat&quot;
 &quot;1.3.6.1.4.1.14519.5.2.1.4591.4001.278082550121070125285213632206.mat&quot;
 &quot;1.3.6.1.4.1.14519.5.2.1.4591.4001.304604545029494418165835320551.mat&quot;
 &quot;1.3.6.1.4.1.14519.5.2.1.4591.4001.335353575986269052491315637674.mat&quot;
 &quot;1.3.6.1.4.1.14519.5.2.1.4591.4001.365805576275232517344053939830.mat&quot;
 &quot;1.3.6.1.4.1.14519.5.2.1.4591.4001.763554173270318063812534542847.mat&quot;
 &quot;1.3.6.1.4.1.14519.5.2.1.4591.4001.961791689281776173751323306588.mat&quot;</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../downloading/">« Downloading</a><a class="docs-footer-nextpage" href="../fitting/">Fitting »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 17 December 2019 20:52">Tuesday 17 December 2019</span>. Using Julia version 1.3.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
